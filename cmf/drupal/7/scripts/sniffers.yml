---
- hosts: localhost
  gather_facts: no
  connection: local
  become: yes

  vars_files:
    - ../config.yml
    - vars/main.yml
    - vars/tests.yml

  tasks:
    - include: tasks/environment/initialize.yml

    - name: Create directory for reports
      file:
        path: "{{ reports.dir }}"
        mode: 0755
        state: "{{ item }}"
      with_items: ["absent", "directory"]

    - name: Run security review
      shell: "drush en security_review -y && drush secrev 2>&1 | grep error | awk '{$NF=\"\"}1' > {{ reports.dir }}/security_review.txt && drush dis security_review -y"
      args:
        chdir: "{{ project_workspace }}"
      environment: "{{ env_vars }}"

    - include: tasks/misc/report-link.yml
      args:
        data:
          type: "security_review"
          title: "Security review"

    - name: Run CodeSniffer
      shell: "phpcs --standard={{ item }} --extensions={{ phpcs.extensions | join(',') }} -n {{ scan_dirs | join(' ') }} > {{ reports.dir }}/phpcs.{{ item }}.txt"
      args:
        chdir: "{{ project_workspace }}"
      with_items: "{{ phpcs.standards }}"
      # Needed for ignoring PHP notices in packages with sniffers.
      ignore_errors: yes

    - include: tasks/misc/report-link.yml
      args:
        data:
          type: "phpcs.{{ item }}"
          title: "CodeSniffer {{ item }}"
      with_items: "{{ phpcs.standards }}"

    - name: Run JSHint
      shell: 'find {{ item }} ! -path "*mute*" -type f \( -iname "*.js" ! -iname "*min.js" \) -print0 | sudo xargs -0 jshint > {{ reports.dir }}/jshint.txt'
      args:
        chdir: "{{ project_workspace }}"
      with_items: "{{ scan_dirs }}"
      # Needed for ignoring exit status codes.
      ignore_errors: yes

    - include: tasks/misc/report-link.yml
      args:
        data:
          type: "jshint"
          title: "JS Hint"

    - name: Run SCSSLint
      shell: 'find {{ item }} -name "*.scss" -print0 | xargs -0 -r scss-lint -c ../scripts/configs/scss-lint.yml > {{ reports.dir }}/scsslint.txt'
      args:
        chdir: "{{ project_workspace }}"
      with_items: "{{ scan_dirs }}"
      # Needed for ignoring exit status codes.
      ignore_errors: yes

    - include: tasks/misc/report-link.yml
      args:
        data:
          type: "scsslint"
          title: "SCSS Lint"
